kind: pipeline
name: default
clone:
  depth: 1

# XXX hack for cwd failure
workspace:
  base: /tmp
  path: "."
# /XXX

steps:
- name: build
  image: docker
  privileged: true
  environment:
    DOCKER_LAUNCH_DEBUG: "true"
    DOCKER_HOST: "unix:///var/run/docker_host.sock"
  commands:
  - env
  - docker build .
  volumes:
  - name: docker_sock
    path: /var/run/docker_host.sock

- name: push
  image: plugins/ecr
  settings:
    repo: 577012953595.dkr.ecr.us-west-2.amazonaws.com/relay-web-app
    registry: 577012953595.dkr.ecr.us-west-2.amazonaws.com
    region: us-west-2
    tags: dev
    when:
      branch:master

volumes:
- name: docker_sock
  host:
    path: /var/run/docker.sock
